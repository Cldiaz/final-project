{"version":3,"sources":["routes/tickets.ts"],"names":[],"mappings":"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","file":"routes/tickets.js","sourcesContent":["import express = require('express');\r\nvar router = express.Router();\r\n\r\n//db references\r\nimport mongoose = require('mongoose');\r\n\r\nimport ticketModel = require('../models/ticket');\r\n\r\nimport Ticket = ticketModel.Ticket;\r\n\r\n//utility function to check if user is authenticated\r\nfunction requireAuth(req: express.Request, res: express.Response, next: any){\r\n    //check if user is log in\r\n    if(!req.isAuthenticated()){\r\n        return res.redirect('/login');\r\n    }\r\n    next();\r\n}\r\n//utitlity to check ticket priority\r\nfunction checkPriority(urgency,impact){  \r\n    switch(urgency)\r\n    {\r\n        case 'LOW':\r\n            if(impact == 'LOW'){\r\n                return 5;\r\n            }else if(impact == 'MEDIUM'){\r\n                return 4;\r\n            }else if(impact == 'HIGH'){\r\n                return 3;\r\n            }\r\n            break;\r\n        case 'MEDIUM':\r\n            if(impact == 'LOW'){\r\n                return 4;\r\n            }else if(impact == 'MEDIUM'){\r\n                return 3;\r\n            }else if(impact == 'HIGH'){\r\n                return 2;\r\n            }\r\n            break;\r\n         case 'HIGH':\r\n            if(impact == 'LOW'){\r\n                return 3;\r\n            }else if(impact == 'MEDIUM'){\r\n                return 2;\r\n            }else if(impact == 'HIGH'){\r\n                return 1;\r\n            }\r\n            break;                     \r\n    }\r\n};\r\n//get tickets page\r\nrouter.get('/', requireAuth,(req:express.Request, res:express.Response, next: any) =>{\r\n    var typeUser = req.user ? req.user.type : '';\r\n    if( typeUser == 'Admin'){\r\n        //use the Ticket model to query the Tickets collection\r\n        Ticket.find({}).sort({'ticketPriority': 1}).exec(function(error, tickets){\r\n            if(error){\r\n                console.log(error);\r\n                res.end(error);\r\n            }\r\n            else {\r\n                //no error, list of tickets\r\n                res.render('tickets/index',{\r\n                    title: 'Dashboard',\r\n                    tickets : tickets,\r\n                    typeU: typeUser,\r\n                    type: req.user.type,\r\n                    displayName: req.user ? req.user.displayName : ''\r\n                });\r\n            }\r\n        });      \r\n    }\r\n    else{\r\n        res.redirect('/tickets/mytickets');\r\n    }\r\n});\r\n// GET my tickets\r\nrouter.get('/mytickets', requireAuth, (req: express.Request, res: express.Response, next: any) => {\r\n\r\n    //var userId = '56ff1229fcd561a00b83d51f';\r\n    //var userId:String = req.user ? req.user.id : ''; \r\n    var userId = req.user ? req.user.username : ''; \r\n    \r\n    Ticket.find({'createdBy' : userId}).sort({'ticketPriority': 1}).exec((error, tickets) => {\r\n        if (error) {\r\n            console.log(error);\r\n            res.end(error);\r\n        }\r\n        else {\r\n            //show the edit view\r\n            res.render('tickets/mytickets', {\r\n                title: 'My Tickets',\r\n                tickets: tickets,\r\n                type: req.user.type, \r\n                displayName: req.user ? req.user.displayName : ''\r\n            });\r\n        }\r\n    });\r\n});\r\n\r\n// get add page\r\nrouter.get('/add', requireAuth,(req: express.Request, res: express.Response, next: any)=> {\r\n    res.render('tickets/add', {\r\n        title: 'Create New Ticket',\r\n        type: req.user.type,\r\n        displayName: req.user ? req.user.displayName : ''\r\n    });\r\n});\r\n\r\n// POST add page - save the new ticket\r\nrouter.post('/add', requireAuth, (req: express.Request, res: express.Response, next: any) => { \r\n    var createdBy = req.user ? req.user.username : ''; \r\n    var priority = checkPriority(req.body.ticketUrgency,req.body.ticketImpact);\r\n    Ticket.create({     \r\n        ticketTitle: req.body.ticketTitle,\r\n        createdBy: createdBy,\r\n        ticketDescription: req.body.ticketDescription,              \r\n        customerName: req.body.customerName,\r\n        customerPhone: req.body.customerPhone,\r\n        ticketUrgency: req.body.ticketUrgency,\r\n        ticketImpact: req.body.ticketImpact,\r\n        ticketPriority: priority, \r\n        incidentNarrative : \r\n            {comment : 'Ticket submitted'}       \r\n    }, function(error, Ticket) {\r\n        // did we get back an error or valid Ticket object?\r\n        if (error) {\r\n            console.log(error);\r\n            res.end(error);\r\n        }\r\n        else {\r\n            res.redirect('/tickets');\r\n        }\r\n    })\r\n});\r\n// GET edit page - show the current ticket in the form\r\nrouter.get('/:id', requireAuth, (req: express.Request, res: express.Response, next: any) => {\r\n    var id = req.params.id;\r\n    var typeUser = req.user ? req.user.type : '';\r\n    Ticket.findById(id, (error, Ticket) => {\r\n        if (error) {\r\n            console.log(error);\r\n            res.end(error);\r\n        }\r\n        else {\r\n            //show the edit view\r\n            res.render('tickets/edit', {\r\n                title: 'Ticket Details',\r\n                ticket: Ticket,\r\n                typeU: typeUser,\r\n                type: req.user.type,\r\n                displayName: req.user ? req.user.displayName : ''\r\n            });\r\n        }\r\n    });\r\n});\r\n// POST edit page - update the selected ticket\r\nrouter.post('/:id', requireAuth,(req: express.Request, res: express.Response, next: any) => {\r\n    // grab the id from the url parameter\r\n    var id = req.params.id;\r\n    var priority = checkPriority(req.body.ticketUrgency,req.body.ticketImpact);\r\n    var urgency = req.body.ticketUrgency;\r\n    var impact = req.body.ticketImpact;\r\n    // create and populate a ticket object\r\n    var ticket = new Ticket({\r\n        _id: id,\r\n        ticketTitle: req.body.ticketTitle,\r\n        ticketDescription: req.body.ticketDescription,\r\n        ticketPriority: req.body.ticketPriority,\r\n        customerName: req.body.customerName,\r\n        customerPhone: req.body.customerPhone,\r\n        ticketStatus: req.body.ticketStatus,\r\n        incidentNarrative : [{\r\n            comment: req.body.comment\r\n        }],\r\n    });\r\n    var incidentComment = req.body.comment;\r\n    var incidentStatus = req.body.ticketStatus;\r\n    // run the update using mongoose and our model\r\n    Ticket.update({ _id: id},{$set:{ticketUrgency: urgency, ticketImpact: impact, ticketPriority:priority }}, error =>{\r\n        if (error) {\r\n            console.log(error);\r\n            res.end(error);\r\n        }\r\n    });\r\n    // run the update using mongoose and our model\r\n    Ticket.update({ _id: id }, {$push: {incidentNarrative:{comment : incidentComment, ticketStatus :incidentStatus}}}, (error) => {\r\n        if (error) {\r\n            console.log(error);\r\n            res.end(error);\r\n        }\r\n        else {\r\n            //if success update\r\n            res.redirect('/tickets');\r\n        }\r\n    });\r\n});\r\n// make this public\r\nmodule.exports = router;"],"sourceRoot":"/source/"}